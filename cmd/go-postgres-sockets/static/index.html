<!DOCTYPE html>
<html lang="en">
<head>
<title>Postgres DB Notifications</title>
<script type="text/javascript">
window.onload = function () {
    let apiKey;
    let conn;
    const log = document.getElementById("log");

    function newLogItem(html, selector) {
        const item = document.createElement("div");
        if (selector) {
            item.className = selector;
        }
        if (html) {
            item.innerHTML = html;
        }
        appendLogItem(item);
    }

    function appendLogItem(item) {
        const doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
        log.appendChild(item);
        if (doScroll) {
            log.scrollTop = log.scrollHeight - log.clientHeight;
        }
    }

    $(document).on('click', '#authForm button', function(e) {
        const payload = {
            authKey : $("#authForm input[type=password]").val()
        };
        $.ajax({
            url : '/authenticate',
            dataType : 'json',
            contentType: "application/json",
            timeout : 2000,
            data: JSON.stringify(payload),
            method : 'POST'
        }).done(function(data, textStatus, jqXHR) {
            apiKey = data;
            $('#authForm').hide();
            $('#notificationForm').show();
            $("#notificationForm input[type=text]").focus();

            function socketConnect() {
                conn = new WebSocket("ws://" + document.location.host + "/ws");
                conn.onopen = function (evt) {
                    newLogItem("<b>socket opened</b>");
                };
                conn.onclose = function (evt) {
                    newLogItem("<b>socket closed</b>");
                    setTimeout(function() {
                        socketConnect();
                    }, 5000);
                };
                conn.onmessage = function (evt) {
                    newLogItem(null, 'mono');
                    const msgParts = evt.data.split('\n');
                    for (let i = 0; i < msgParts.length; i++) {
                        const html = msgParts[i].replaceAll(" ", "&nbsp;")
                        newLogItem(html, 'mono');
                    }
                };
            }
            socketConnect();
        });
        e.preventDefault();
    });

    $(document).on('click', '#notificationForm button', function(e) {
        const payload = {
            notificationType : parseInt($("#notificationForm select").val()),
            notificationText : $("#notificationForm input[type=text]").val(),
            apiKey : apiKey
        };
        $.ajax({
            url : '/addNotification',
            dataType : 'json',
            contentType: "application/json",
            timeout : 2000,
            data: JSON.stringify(payload),
            method : 'PUT'
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log('addNotification ajax call failure', jqXHR, textStatus, errorThrown);
        }).done(function(){
            $("#notificationForm input[type=text]").val("");
            $("#notificationForm input[type=text]").focus();
        });
        e.preventDefault();
    });

    $(document).ready(function() {
        if (!window["WebSocket"]) {
            newLogItem(null, "<b>Your browser does not support WebSockets</b>");
        } else {
            $('#authForm').show();
            $("#authForm input[type=password]").focus();
        }
    });
};
</script>
<style>
html {
    overflow: hidden;
}

body {
    overflow: hidden;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: gray;
}

#log {
    background: white;
    margin: 0;
    padding: 0.5em 0.5em 0.5em 0.5em;
    position: absolute;
    top: 0.5em;
    left: 0.5em;
    right: 0.5em;
    bottom: 3em;
    overflow: auto;
}

#log .mono {
    font-family: 'Courier New', monospace;
    min-height: 15px;

}

#authForm, #notificationForm {
    display: none;
    padding: 0 0.5em 0 0.5em;
    margin: 0;
    position: absolute;
    bottom: 1em;
    left: 0px;
    width: 100%;
    overflow: hidden;
}

#authForm input[type=text],
#notificationForm input[type=text] {
    width: 300px;
}
</style>
</head>
<body>
<div id="log"></div>
<form id="authForm">
    <input type="password" id="authKey" size="64" autofocus  />
    <button>Authenticate</button>
</form>
<form id="notificationForm">
    <select>
        <option value="0">None</option>
        <option value="1" selected>Email</option>
        <option value="2">SMS</option>
        <option value="3">Slack</option>
    </select>
    <input type="text" id="msg" size="64" autofocus />
    <button>New DB Notification</button>
</form>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</html>