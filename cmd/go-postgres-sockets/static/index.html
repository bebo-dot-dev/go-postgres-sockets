<!DOCTYPE html>
<html lang="en">
<head>
<title>Postgres DB Notifications</title>
<script type="text/javascript">
window.onload = function () {
    let conn;
    const log = document.getElementById("log");

    function newLogItem(html, selector) {
        const item = document.createElement("div");
        if (selector) {
            item.className = selector;
        }
        if (html) {
            item.innerHTML = html;
        }
        appendLogItem(item);
    }

    function appendLogItem(item) {
        const doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
        log.appendChild(item);
        if (doScroll) {
            log.scrollTop = log.scrollHeight - log.clientHeight;
        }
    }

    document.getElementById("form").onsubmit = function () {
        const payload = {};
        payload.notificationType = parseInt($("#form select").val());
        payload.notificationText = $("#form input[type=text]").val();
        $.ajax({
            url : '/addNotification',
            dataType : 'json',
            contentType: "application/json",
            timeout : 2000,
            data: JSON.stringify(payload),
            method : 'PUT'
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log('addNotification ajax call failure', jqXHR, textStatus, errorThrown);
        });
        return false;
    };

    if (window["WebSocket"]) {
        conn = new WebSocket("ws://" + document.location.host + "/ws");
        conn.onopen = function (evt) {
            newLogItem("<b>socket opened</b>");
        };
        conn.onclose = function (evt) {
            newLogItem("<b>socket closed</b>");
        };
        conn.onmessage = function (evt) {
            newLogItem(null, 'mono');
            const msgParts = evt.data.split('\n');
            for (let i = 0; i < msgParts.length; i++) {
                const html = msgParts[i].replaceAll(" ", "&nbsp;")
                newLogItem(html, 'mono');
            }
        };
    } else {
        newLogItem(null, "<b>Your browser does not support WebSockets</b>");
    }
};
</script>
<style>
html {
    overflow: hidden;
}

body {
    overflow: hidden;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: gray;
}

#log {
    background: white;
    margin: 0;
    padding: 0.5em 0.5em 0.5em 0.5em;
    position: absolute;
    top: 0.5em;
    left: 0.5em;
    right: 0.5em;
    bottom: 3em;
    overflow: auto;
}

#log .mono {
    font-family: 'Courier New', monospace;
    min-height: 15px;

}

#form {
    padding: 0 0.5em 0 0.5em;
    margin: 0;
    position: absolute;
    bottom: 1em;
    left: 0px;
    width: 100%;
    overflow: hidden;
}

#form input[type=text] {
    width: 300px;
}
</style>
</head>
<body>
<div id="log"></div>
<form id="form">    
    <select>
        <option value="0">None</option>
        <option value="1" selected>Email</option>
        <option value="2">SMS</option>
        <option value="3">Slack</option>
    </select>
    <input type="text" id="msg" size="64" autofocus />
    <input type="submit" value="New DB Notification" />
</form>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</html>